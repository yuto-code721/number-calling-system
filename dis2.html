<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DISPLAY</title>

<style>
body {
    background: black;
    color: white;
    text-align: center;
    margin-top: 40px;
    font-family: sans-serif;
    transition: background 0.5s;
}

#container {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-top: 60px;
}

.number-box {
    font-size: 160px;
    font-weight: bold;
    padding: 20px 40px;
    background: #111;
    border-radius: 20px;
    animation: fadeZoom 0.6s ease-out;
}

@keyframes fadeZoom {
    0% { opacity: 0; transform: scale(0.6); }
    100% { opacity: 1; transform: scale(1); }
}

#soundButton {
    position:fixed;
    top:20px;
    right:20px;
    font-size:32px;
    padding:15px 25px;
    background:#28a745;
    color:white;
    border:none;
    border-radius:12px;
    cursor:pointer;
    z-index:9999;
}
</style>
</head>

<body>

<button id="soundButton" onclick="enableAudio()">音声を有効にする</button>

<h1 style="font-size:60px;">呼び出し番号</h1>

<div id="container"></div>

<script>
const API_KEY = "K909e8S5e914j89";
let voiceType = "metan";
let lastList = [];
let audioUnlocked = false;

// iPad 音声解除（実際に鳴らす）
function enableAudio() {
    let a = new Audio("sound/Windows20Exclamation.wav");
    a.play().then(() => {
        audioUnlocked = true;
        document.getElementById("soundButton").style.display = "none";
    });
}

// 背景変更
function updateBackground() {
    if (voiceType === "zundamon") {
        document.body.style.background = "#0d7f3e";
    } else {
        document.body.style.background = "black";
    }
}
updateBackground();

// 声設定取得
function fetchVoiceType() {
    fetch("voice.txt")
        .then(r => r.text())
        .then(t => {
            t = t.trim();
            if (t === "metan" || t === "zundamon") {
                voiceType = t;
                updateBackground();
            }
        });
}

// 番号更新
function update() {
    fetch("server.php")
        .then(r => r.text())
        .then(txt => {
            let list = txt.trim() === "" ? [] : txt.trim().split(",");
            displayNumbers(list);

            // 新規番号のみ読み上げ
            if (list.length > lastList.length) {
                let newN = list.filter(n => !lastList.includes(n));
                if (newN.length > 0) playSound(newN[0]);
            }

            lastList = list;
        });

    fetchVoiceType();
}

// 表示
function displayNumbers(list) {
    const c = document.getElementById("container");
    c.innerHTML = "";
    list.forEach(n => {
        let d = document.createElement("div");
        d.className = "number-box";
        d.innerText = n;
        c.appendChild(d);
    });
}

// ---- iPad対応：VOICEVOXを fetch → blob → Audioで再生 ----
async function playSound(num) {
    if (!audioUnlocked) return;

    // ピンポン（OK）
    let pin = new Audio("sound/Windows20Exclamation.wav");
    await pin.play().catch(()=>{});

    let text = "";
    let speaker = 0;

    if (voiceType === "zundamon") {
        text = `${num}番のひと、できたのだ！`;
        speaker = 3;
    } else {
        text = `${num}番のお客様、商品ができました。`;
        speaker = 0;
    }

    let url =
        `https://deprecatedapis.tts.quest/v2/voicevox/audio/?key=${API_KEY}` +
        `&speaker=${speaker}&pitch=0&intonationScale=1&speed=1&text=` +
        encodeURIComponent(text);

    try {
        // 外部音声をfetch（iPadで必須）
        let res = await fetch(url);
        let blob = await res.blob();
        let blobUrl = URL.createObjectURL(blob);

        let voice = new Audio(blobUrl);
        voice.play().catch(e=>{
            console.log("VOICEVOX再生失敗", e);
        });

    } catch (e) {
        console.log("fetch失敗", e);
    }
}

setInterval(update, 1000);
update();
</script>

</body>
</html>